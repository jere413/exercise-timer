<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Exercise Timer</title>

<link rel="manifest" href="manifest.json" />

<style>
body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  color: white;
  text-align: center;

  /* Background Option A â€“ Spotlight */
  background:
    radial-gradient(
      circle at center,
      #1f1f1f 0%,
      #141414 40%,
      #0e0e0e 75%,
      #000000 100%
    );
  background-attachment: fixed;
}

.container {
  padding: 20px;
}

.phase {
  font-size: 3rem;
  font-weight: bold;
  margin-top: 20px;
  letter-spacing: 3px;
}

.round {
  font-size: 1.5rem;
  margin-bottom: 10px;
  opacity: 0.8;
}

.timer-display {
  font-size: 8rem;
  font-weight: bold;
  margin: 20px 0;
  text-shadow: 0 0 25px rgba(255,255,255,0.08);
}

.controls button,
.presets button {
  font-size: 1.5rem;
  padding: 15px 30px;
  margin: 10px;
  border-radius: 12px;
  border: none;
  cursor: pointer;
}

button:active {
  transform: scale(0.97);
}

input {
  font-size: 1.2rem;
  padding: 8px;
  width: 70px;
  margin: 5px;
  text-align: center;
}

.hidden {
  display: none;
}
</style>
</head>
<body>
<div class="container">

<div class="phase" id="phaseLabel">READY</div>
<div class="round" id="roundLabel">ROUND 1 / 1</div>
<div class="timer-display" id="display">00:00</div>

<div id="inputs">
  <div>
    <h3>Countdown (Prepare)</h3>
    <input id="cdMin" type="number" min="0" value="0"> :
    <input id="cdSec" type="number" min="0" max="59" value="10">
  </div>

  <div>
    <h3>Count Up (Exercise)</h3>
    <input id="cuMin" type="number" min="0" value="0"> :
    <input id="cuSec" type="number" min="0" max="59" value="30">
  </div>

  <div>
    <h3>Repeat Rounds</h3>
    <input id="rounds" type="number" min="1" value="1">
  </div>
</div>

<div class="controls">
  <button onclick="startTimer()">START</button>
  <button onclick="stopTimer()">STOP</button>
  <button onclick="resetTimer()">RESET</button>
</div>

<div class="presets">
  <button onclick="savePreset()">Save Preset</button>
  <button onclick="loadPreset()">Load Preset</button>
</div>

</div>

<script>
let timer = null;
let wakeLock = null;
let state = "IDLE";
let currentRound = 1;
let totalRounds = 1;
let startTime = null;
let duration = 0;
let audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function formatTime(seconds) {
  let m = Math.floor(seconds / 60).toString().padStart(2,'0');
  let s = (seconds % 60).toString().padStart(2,'0');
  return `${m}:${s}`;
}

function beep(freq=1000, length=0.2, volume=0.8) {
  let osc = audioCtx.createOscillator();
  let gain = audioCtx.createGain();
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.frequency.value = freq;
  gain.gain.value = volume;
  osc.start();
  osc.stop(audioCtx.currentTime + length);
}

function vibrate() {
  if (navigator.vibrate) navigator.vibrate([200,100,200]);
}

async function requestWakeLock() {
  if ('wakeLock' in navigator) {
    try {
      wakeLock = await navigator.wakeLock.request('screen');
    } catch (err) {}
  }
}

function releaseWakeLock() {
  if (wakeLock) wakeLock.release();
}

function updateDisplay(seconds) {
  document.getElementById("display").textContent = formatTime(seconds);
}

function startCountdown() {
  state = "COUNTDOWN";
  document.getElementById("phaseLabel").textContent = "GET READY";
  duration = parseInt(cdMin.value)*60 + parseInt(cdSec.value);
  startTime = Date.now();
}

function startCountUp() {
  state = "COUNTUP";
  document.getElementById("phaseLabel").textContent = "WORK";
  duration = parseInt(cuMin.value)*60 + parseInt(cuSec.value);
  startTime = Date.now();
}

function startTimer() {
  if (state !== "IDLE") return;

  totalRounds = parseInt(rounds.value);
  currentRound = 1;
  document.getElementById("roundLabel").textContent =
    `ROUND ${currentRound} / ${totalRounds}`;

  document.getElementById("inputs").classList.add("hidden");

  requestWakeLock();
  preCountdown(3);
}

function preCountdown(seconds) {
  let count = seconds;
  document.getElementById("phaseLabel").textContent = count;

  let interval = setInterval(() => {
    beep(1200,0.1,1);
    count--;
    if (count > 0) {
      document.getElementById("phaseLabel").textContent = count;
    } else {
      clearInterval(interval);
      beep(1500,0.3,1);
      startCountdown();
    }
  }, 1000);
}

function stopTimer() {
  clearInterval(timer);
  releaseWakeLock();
  state = "IDLE";
}

function resetTimer() {
  stopTimer();
  document.getElementById("phaseLabel").textContent = "READY";
  document.getElementById("display").textContent = "00:00";
  document.getElementById("inputs").classList.remove("hidden");
  currentRound = 1;
}

function runTimer() {
  timer = setInterval(() => {
    let elapsed = Math.floor((Date.now() - startTime)/1000);

    if (state === "COUNTDOWN") {
      let remaining = duration - elapsed;
      if (remaining >= 0) {
        updateDisplay(remaining);
      } else {
        beep(1000,0.4,1);
        vibrate();
        startCountUp();
      }
    }
    else if (state === "COUNTUP") {
      if (elapsed <= duration) {
        updateDisplay(elapsed);
      } else {
        beep(800,0.6,1);
        vibrate();
        currentRound++;
        if (currentRound <= totalRounds) {
          document.getElementById("roundLabel").textContent =
            `ROUND ${currentRound} / ${totalRounds}`;
          startCountdown();
        } else {
          document.getElementById("phaseLabel").textContent = "COMPLETE";
          stopTimer();
        }
      }
    }
  }, 200);
}

document.addEventListener("visibilitychange", () => {
  if (document.visibilityState === "visible" && wakeLock !== null) {
    requestWakeLock();
  }
});

setInterval(() => {
  if (state === "COUNTDOWN" || state === "COUNTUP") runTimer();
}, 500);

function savePreset() {
  const preset = {
    cdMin: cdMin.value,
    cdSec: cdSec.value,
    cuMin: cuMin.value,
    cuSec: cuSec.value,
    rounds: rounds.value
  };
  localStorage.setItem("timerPreset", JSON.stringify(preset));
  alert("Preset saved.");
}

function loadPreset() {
  const preset = JSON.parse(localStorage.getItem("timerPreset"));
  if (preset) {
    cdMin.value = preset.cdMin;
    cdSec.value = preset.cdSec;
    cuMin.value = preset.cuMin;
    cuSec.value = preset.cuSec;
    rounds.value = preset.rounds;
    alert("Preset loaded.");
  }
}
</script>
</body>
</html>
